<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì˜ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .auth-code-box { font-size: 3rem; letter-spacing: 10px; font-weight: bold; color: #4a90e2; border: 2px dashed #4a90e2; padding: 20px; border-radius: 10px; background: #f8f9fa; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #4a90e2; border-top: 3px solid #4a90e2; }
        .session-btn { text-align: left; }
        .session-date { font-size: 0.8rem; color: #6c757d; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="/static/instructor_home.html" class="btn btn-outline-secondary">â† ê°•ì˜ ëª©ë¡</a>
            <span class="badge bg-primary fs-6" id="courseNameBadge">ê°•ì˜ëª… ë¡œë”©ì¤‘</span>
        </div>

        <div class="row">
            <div class="col-md-3">
                <h6 class="text-muted fw-bold mb-3">ìˆ˜ì—… ì£¼ì°¨ ì„ íƒ</h6>
                <div class="list-group shadow-sm" id="sessionList"></div>
            </div>

            <div class="col-md-9">
                <div class="card shadow-sm" id="mainCard" style="display:none;">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('control')">ğŸ“¡ ìˆ˜ì—… ì œì–´</a></li>
                            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('roster')">ğŸ“‹ í•™ìƒ ëª…ë¶€</a></li>
                        </ul>
                    </div>
                    
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-bold m-0" id="panelTitle">Nì£¼ì°¨ ìˆ˜ì—…</h4>
                            <button class="btn btn-sm btn-outline-warning fw-bold" onclick="openRescheduleModal()">ğŸ“… ë‚ ì§œ/ë³´ê°• ë³€ê²½</button>
                        </div>

                        <div id="tab-control">
                            <div id="holidayAlert" class="alert alert-danger text-center" style="display:none;">
                                <strong>â›” ì˜¤ëŠ˜ì€ ê³µíœ´ì¼(ê³µê²°)ì…ë‹ˆë‹¤.</strong><br>ìˆ˜ì—…ì„ ì§„í–‰í•˜ë ¤ë©´ ìœ„ 'ë‚ ì§œ/ë³´ê°• ë³€ê²½' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‚ ì§œë¥¼ ë³€ê²½í•˜ì„¸ìš”.
                            </div>

                            <div class="row text-center" id="controlPanel">
                                <div class="col-md-6 mb-4 border-end">
                                    <label class="form-label fw-bold text-muted">ì¶œì„ ë°©ì‹</label>
                                    <div class="d-flex justify-content-center gap-2 mb-3">
                                        <input type="radio" class="btn-check" name="method" id="m1" value="ELECTRONIC" checked>
                                        <label class="btn btn-outline-primary" for="m1">ğŸ“± ì „ìì¶œê²°</label>
                                        <input type="radio" class="btn-check" name="method" id="m2" value="AUTH_CODE">
                                        <label class="btn btn-outline-primary" for="m2">ğŸ”¢ ì¸ì¦ë²ˆí˜¸</label>
                                    </div>
                                    <button id="btnToggle" class="btn btn-success w-100 py-3 fw-bold" onclick="toggleAttendance()">ì¶œì„ ì‹œì‘ (OPEN)</button>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label class="form-label fw-bold text-muted">ì‹¤ì‹œê°„ í˜„í™©</label>
                                    <h1 class="display-4 fw-bold mb-0 text-primary">
                                        <span id="liveAttended">0</span>/<span id="liveTotal">0</span>
                                    </h1>
                                </div>
                            </div>
                            <div id="authCodeArea" class="text-center mt-3" style="display:none;">
                                <div class="auth-code-box" id="authCodeDisplay">----</div>
                                <p class="text-muted mt-2">í•™ìƒë“¤ì—ê²Œ ì´ ë²ˆí˜¸ë¥¼ ê³µìœ í•˜ì„¸ìš”</p>
                            </div>
                        </div>

                        <div id="tab-roster" style="display:none;">
                            <table class="table table-hover align-middle">
                                <thead class="table-light"><tr><th>ì´ë¦„</th><th>í•™ë²ˆ/ì´ë©”ì¼</th><th>ìƒíƒœ ë³€ê²½</th></tr></thead>
                                <tbody id="rosterTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="emptyState" class="text-center py-5 text-muted"><h5>ğŸ‘ˆ ì™¼ìª½ì—ì„œ ê´€ë¦¬í•  ìˆ˜ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h5></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="rescheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ“… ìˆ˜ì—… ë‚ ì§œ ë³€ê²½ (ë³´ê°•)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p>í˜„ì¬ ë‚ ì§œ: <strong id="currentDateDisplay"></strong></p>
                    <label class="form-label">ë³€ê²½í•  ë‚ ì§œ ë° ì‹œê°„</label>
                    <input type="datetime-local" id="newSessionDate" class="form-control">
                    <div class="form-text text-danger">* ë‚ ì§œë¥¼ ë³€ê²½í•˜ë©´ 'ê³µíœ´ì¼' ìƒíƒœê°€ í•´ì œë˜ê³  ì •ìƒ ìˆ˜ì—…ì´ ë©ë‹ˆë‹¤.</div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="submitReschedule()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const COURSE_ID = urlParams.get('id') || 1;
        let currentSessionId = null;
        let currentSessionDate = null;
        let refreshTimer = null;

        document.addEventListener('DOMContentLoaded', loadSessions);

        function switchTab(tabName) {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-control').style.display = tabName==='control'?'block':'none';
            document.getElementById('tab-roster').style.display = tabName==='roster'?'block':'none';
            if(tabName==='roster') loadRoster();
        }

        async function loadSessions() {
            const res = await fetch(`/instructor/courses/${COURSE_ID}/sessions`);
            const sessions = await res.json();
            const list = document.getElementById('sessionList');
            list.innerHTML = '';
            
            sessions.forEach(s => {
                let badge = s.is_open ? '<span class="badge bg-success rounded-pill float-end">OPEN</span>' : '';
                // [í•µì‹¬] ê³µíœ´ì¼ ë±ƒì§€
                if(s.is_holiday) badge = '<span class="badge bg-danger rounded-pill float-end">ê³µíœ´ì¼</span>';
                
                const d = new Date(s.session_date);
                const dateStr = `${d.getMonth()+1}/${d.getDate()} (${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]})`;

                list.innerHTML += `
                    <button class="list-group-item list-group-item-action session-btn" 
                        onclick="selectSession(${s.id}, ${s.week_number}, ${s.is_open}, '${s.attendance_method}', ${s.is_holiday}, '${s.session_date}')">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div><span class="fw-bold">${s.week_number}ì£¼ì°¨</span> <span class="session-date ms-2">${dateStr}</span></div>
                            ${badge}
                        </div>
                    </button>`;
            });
        }

        function selectSession(id, week, isOpen, method, isHoliday, dateStr) {
            currentSessionId = id;
            currentSessionDate = dateStr;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('mainCard').style.display = 'block';
            document.getElementById('panelTitle').textContent = `${week}ì£¼ì°¨ ìˆ˜ì—… ê´€ë¦¬`;
            
            // ê³µíœ´ì¼ ì²˜ë¦¬ UI
            const holidayAlert = document.getElementById('holidayAlert');
            const controlPanel = document.getElementById('controlPanel');
            if(isHoliday) {
                holidayAlert.style.display = 'block';
                controlPanel.style.opacity = '0.5'; // ë¹„í™œì„±í™” ëŠë‚Œ
                controlPanel.style.pointerEvents = 'none'; // í´ë¦­ ë°©ì§€
            } else {
                holidayAlert.style.display = 'none';
                controlPanel.style.opacity = '1';
                controlPanel.style.pointerEvents = 'auto';
            }

            document.querySelector(`input[name="method"][value="${method}"]`).checked = true;
            updateControlUI(isOpen, method);
            
            if (refreshTimer) clearInterval(refreshTimer);
            loadLiveStat();
            refreshTimer = setInterval(loadLiveStat, 3000);
            if(document.getElementById('tab-roster').style.display === 'block') loadRoster();
        }

        // ë³´ê°•ì¼ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
        function openRescheduleModal() {
            document.getElementById('currentDateDisplay').textContent = new Date(currentSessionDate).toLocaleString();
            new bootstrap.Modal(document.getElementById('rescheduleModal')).show();
        }

        async function submitReschedule() {
            const newDate = document.getElementById('newSessionDate').value;
            if(!newDate) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            const res = await fetch(`/instructor/sessions/${currentSessionId}/date`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ session_date: newDate })
            });
            if(res.ok) { alert("ë‚ ì§œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
            else alert("ë³€ê²½ ì‹¤íŒ¨");
        }

        async function toggleAttendance() {
            const btn = document.getElementById('btnToggle');
            const isOpening = btn.classList.contains('btn-success');
            const method = document.querySelector('input[name="method"]:checked').value;
            const res = await fetch(`/sessions/${currentSessionId}/status?is_open=${isOpening}&method=${method}`, { method: 'PATCH' });
            if (res.ok) {
                const data = await res.json();
                updateControlUI(isOpening, method, data.auth_code);
                loadSessions(); 
            }
        }

        function updateControlUI(isOpen, method, authCode = null) {
            const btn = document.getElementById('btnToggle');
            const codeArea = document.getElementById('authCodeArea');
            if (isOpen) {
                btn.textContent = "ë§ˆê°í•˜ê¸° (CLOSE)";
                btn.className = "btn btn-danger w-100 py-3 fw-bold";
                if (method === 'AUTH_CODE') {
                    codeArea.style.display = 'block';
                    if (authCode) document.getElementById('authCodeDisplay').textContent = authCode;
                } else codeArea.style.display = 'none';
            } else {
                btn.textContent = "ì¶œì„ ì‹œì‘ (OPEN)";
                btn.className = "btn btn-success w-100 py-3 fw-bold";
                codeArea.style.display = 'none';
            }
        }
        
        async function loadLiveStat() {
            if (!currentSessionId) return;
            const res = await fetch(`/sessions/${currentSessionId}/stat`);
            const data = await res.json();
            document.getElementById('liveAttended').textContent = data.attended;
            document.getElementById('liveTotal').textContent = data.total;
            if (data.auth_code) document.getElementById('authCodeDisplay').textContent = data.auth_code;
        }

        async function loadRoster() {
            if (!currentSessionId) return;
            const res = await fetch(`/instructor/sessions/${currentSessionId}/attendances`);
            const roster = await res.json();
            const tbody = document.getElementById('rosterTable');
            tbody.innerHTML = '';

            roster.forEach(s => {
                // ìƒíƒœê°’: 0:ë¯¸ì •, 1:ì¶œì„, 2:ì§€ê°, 3:ê²°ì„, 4:ê³µê²°, 5:ì‹ ì²­ì¤‘
                const opts = [
                    {v:0,t:'ë¯¸ì •'}, {v:1,t:'ì¶œì„'}, {v:2,t:'ì§€ê°'},
                    {v:3,t:'ê²°ì„'}, {v:4,t:'ê³µê²°(ìŠ¹ì¸)'}, {v:5,t:'â³ì‹ ì²­ì¤‘'}
                ];
                
                let sel = `<select class="form-select form-select-sm" onchange="changeStatus(${s.student_id},this.value)" style="width:120px;">`;
                opts.forEach(o => sel += `<option value="${o.v}" ${s.status===o.v?'selected':''}>${o.t}</option>`);
                sel += `</select>`;

                // íŒŒì¼ ì•„ì´ì½˜ (ìˆìœ¼ë©´ í‘œì‹œ)
                let fileBtn = '';
                if(s.proof_file) {
                    fileBtn = `<a href="/uploads/${s.proof_file}" target="_blank" class="btn btn-sm btn-outline-info ms-2" title="ì¦ë¹™ì„œë¥˜ í™•ì¸">ğŸ“„</a>`;
                }
                
                // ê³µê²° ì‹ ì²­ì¤‘ì¼ ë•Œ ìŠ¹ì¸ ë²„íŠ¼
                let approveBtn = '';
                if(s.status === 5) {
                    approveBtn = `<button class="btn btn-sm btn-primary ms-1" onclick="changeStatus(${s.student_id}, 4)">ìŠ¹ì¸</button>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${s.student_name}</td>
                        <td class="small text-muted">${s.student_number}</td>
                        <td class="d-flex align-items-center">
                            ${sel}
                            ${fileBtn}
                            ${approveBtn}
                        </td>
                    </tr>
                `;
            });
        }
        async function changeStatus(sid, val) {
            await fetch(`/instructor/sessions/${currentSessionId}/attendances`, {
                method:'PATCH', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({student_id:sid, status:parseInt(val)})
            });
            loadLiveStat();
        }
        function goToReport() {
            window.location.href = `/static/instructor_report.html?id=${COURSE_ID}`;
        }
    </script>
</body>
</html>