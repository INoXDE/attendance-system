<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì˜ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .auth-code-box { font-size: 3rem; letter-spacing: 10px; font-weight: bold; color: #4a90e2; border: 2px dashed #4a90e2; padding: 20px; border-radius: 10px; background: #f8f9fa; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #4a90e2; border-top: 3px solid #4a90e2; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="/static/instructor_home.html" class="btn btn-outline-secondary">â† ê°•ì˜ ëª©ë¡</a>
            <span class="badge bg-primary fs-6" id="courseNameBadge">ê°•ì˜ëª… ë¡œë”©ì¤‘</span>
        </div>

        <div class="row">
            <div class="col-md-3">
                <h6 class="text-muted fw-bold mb-3">ìˆ˜ì—… ì£¼ì°¨ ì„ íƒ</h6>
                <div class="list-group shadow-sm" id="sessionList">
                    </div>
            </div>

            <div class="col-md-9">
                <div class="card shadow-sm" id="mainCard" style="display:none;">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" onclick="switchTab('control')">ğŸ“¡ ìˆ˜ì—… ì œì–´</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="switchTab('roster')">ğŸ“‹ í•™ìƒ ëª…ë¶€ & ìˆ˜ì •</a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="card-body p-4">
                        <h4 class="mb-4 fw-bold" id="panelTitle">Nì£¼ì°¨ ìˆ˜ì—…</h4>

                        <div id="tab-control">
                            <div class="row text-center">
                                <div class="col-md-6 mb-4 border-end">
                                    <label class="form-label fw-bold text-muted">ì¶œì„ ë°©ì‹</label>
                                    <div class="d-flex justify-content-center gap-2 mb-3">
                                        <input type="radio" class="btn-check" name="method" id="m1" value="ELECTRONIC" checked>
                                        <label class="btn btn-outline-primary" for="m1">ğŸ“± ì „ìì¶œê²°</label>
                                        <input type="radio" class="btn-check" name="method" id="m2" value="AUTH_CODE">
                                        <label class="btn btn-outline-primary" for="m2">ğŸ”¢ ì¸ì¦ë²ˆí˜¸</label>
                                    </div>
                                    <button id="btnToggle" class="btn btn-success w-100 py-3 fw-bold" onclick="toggleAttendance()">
                                        ì¶œì„ ì‹œì‘ (OPEN)
                                    </button>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label class="form-label fw-bold text-muted">ì‹¤ì‹œê°„ í˜„í™©</label>
                                    <h1 class="display-4 fw-bold mb-0 text-primary">
                                        <span id="liveAttended">0</span>/<span id="liveTotal">0</span>
                                    </h1>
                                </div>
                            </div>
                            
                            <div id="authCodeArea" class="text-center mt-3" style="display:none;">
                                <div class="auth-code-box" id="authCodeDisplay">----</div>
                                <p class="text-muted mt-2">í•™ìƒë“¤ì—ê²Œ ì´ ë²ˆí˜¸ë¥¼ ê³µìœ í•˜ì„¸ìš”</p>
                            </div>
                        </div>

                        <div id="tab-roster" style="display:none;">
                            <div class="d-flex justify-content-end mb-2">
                                <small class="text-muted">* ìƒíƒœë¥¼ ë³€ê²½í•˜ë©´ ì¦‰ì‹œ ì €ì¥ë©ë‹ˆë‹¤.</small>
                            </div>
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ì´ë¦„</th>
                                        <th>í•™ë²ˆ/ì´ë©”ì¼</th>
                                        <th>ìƒíƒœ ë³€ê²½</th>
                                    </tr>
                                </thead>
                                <tbody id="rosterTable">
                                    </tbody>
                            </table>
                        </div>

                    </div>
                </div>
                
                <div id="emptyState" class="text-center py-5 text-muted">
                    <h5>ğŸ‘ˆ ì™¼ìª½ì—ì„œ ê´€ë¦¬í•  ìˆ˜ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h5>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const COURSE_ID = urlParams.get('id') || 1;
        let currentSessionId = null;
        let refreshTimer = null;

        document.addEventListener('DOMContentLoaded', loadSessions);

        // íƒ­ ì „í™˜ ë¡œì§
        function switchTab(tabName) {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'control') {
                document.getElementById('tab-control').style.display = 'block';
                document.getElementById('tab-roster').style.display = 'none';
            } else {
                document.getElementById('tab-control').style.display = 'none';
                document.getElementById('tab-roster').style.display = 'block';
                loadRoster(); // íƒ­ ëˆ„ë¥¼ ë•Œ ëª…ë¶€ ìƒˆë¡œê³ ì¹¨
            }
        }

        async function loadSessions() {
            const res = await fetch(`/instructor/courses/${COURSE_ID}/sessions`);
            const sessions = await res.json();
            const list = document.getElementById('sessionList');
            list.innerHTML = '';
            
            sessions.forEach(s => {
                const badge = s.is_open ? '<span class="badge bg-success rounded-pill">OPEN</span>' : '';
                list.innerHTML += `
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                        onclick="selectSession(${s.id}, ${s.week_number}, ${s.is_open}, '${s.attendance_method}')">
                        ${s.week_number}ì£¼ì°¨ ìˆ˜ì—…
                        ${badge}
                    </button>
                `;
            });
        }

        function selectSession(id, week, isOpen, method) {
            currentSessionId = id;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('mainCard').style.display = 'block';
            document.getElementById('panelTitle').textContent = `${week}ì£¼ì°¨ ìˆ˜ì—… ê´€ë¦¬`;
            
            // UI ì´ˆê¸°í™”
            document.querySelector(`input[name="method"][value="${method}"]`).checked = true;
            updateControlUI(isOpen, method);
            
            // íƒ€ì´ë¨¸ ì¬ì„¤ì •
            if (refreshTimer) clearInterval(refreshTimer);
            loadLiveStat();
            refreshTimer = setInterval(loadLiveStat, 3000);
            
            // ëª…ë¶€ íƒ­ì´ë©´ ëª…ë¶€ë„ ë¡œë“œ
            if(document.getElementById('tab-roster').style.display === 'block') {
                loadRoster();
            }
        }

        // --- íƒ­ 1: ì œì–´ ë¡œì§ ---
        async function toggleAttendance() {
            const btn = document.getElementById('btnToggle');
            const isOpening = btn.classList.contains('btn-success');
            const method = document.querySelector('input[name="method"]:checked').value;

            const res = await fetch(`/sessions/${currentSessionId}/status?is_open=${isOpening}&method=${method}`, { method: 'PATCH' });
            if (res.ok) {
                const data = await res.json();
                updateControlUI(isOpening, method, data.auth_code);
                loadSessions(); // ì‚¬ì´ë“œë°” ê°±ì‹ 
            }
        }

        function updateControlUI(isOpen, method, authCode = null) {
            const btn = document.getElementById('btnToggle');
            const codeArea = document.getElementById('authCodeArea');

            if (isOpen) {
                btn.textContent = "ë§ˆê°í•˜ê¸° (CLOSE)";
                btn.className = "btn btn-danger w-100 py-3 fw-bold";
                if (method === 'AUTH_CODE') {
                    codeArea.style.display = 'block';
                    if (authCode) document.getElementById('authCodeDisplay').textContent = authCode;
                } else { codeArea.style.display = 'none'; }
            } else {
                btn.textContent = "ì¶œì„ ì‹œì‘ (OPEN)";
                btn.className = "btn btn-success w-100 py-3 fw-bold";
                codeArea.style.display = 'none';
            }
        }

        async function loadLiveStat() {
            if (!currentSessionId) return;
            const res = await fetch(`/sessions/${currentSessionId}/stat`);
            const data = await res.json();
            document.getElementById('liveAttended').textContent = data.attended;
            document.getElementById('liveTotal').textContent = data.total;
            if (data.auth_code) document.getElementById('authCodeDisplay').textContent = data.auth_code;
        }

        // --- íƒ­ 2: ëª…ë¶€ ë¡œì§ (ì§ê¶Œ ìˆ˜ì •) ---
        async function loadRoster() {
            if (!currentSessionId) return;
            const res = await fetch(`/instructor/sessions/${currentSessionId}/attendances`);
            const roster = await res.json();
            const tbody = document.getElementById('rosterTable');
            tbody.innerHTML = '';

            roster.forEach(student => {
                // ìƒíƒœ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒì„±
                const options = [
                    {val:0, label:'ë¯¸ì •', color:'#6c757d'},
                    {val:1, label:'ì¶œì„', color:'#198754'},
                    {val:2, label:'ì§€ê°', color:'#ffc107'},
                    {val:3, label:'ê²°ì„', color:'#dc3545'},
                    {val:4, label:'ê³µê²°', color:'#0d6efd'}
                ];
                
                let selectHtml = `<select class="form-select form-select-sm" onchange="changeStatus(${student.student_id}, this.value)" style="width:100px;">`;
                options.forEach(opt => {
                    const selected = student.status === opt.val ? 'selected' : '';
                    selectHtml += `<option value="${opt.val}" ${selected}>${opt.label}</option>`;
                });
                selectHtml += `</select>`;

                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${student.student_name}</td>
                        <td class="text-muted small">${student.email}</td>
                        <td>${selectHtml}</td>
                    </tr>
                `;
            });
        }

        async function changeStatus(studentId, newStatus) {
            try {
                const res = await fetch(`/instructor/sessions/${currentSessionId}/attendances`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ student_id: studentId, status: parseInt(newStatus) })
                });
                if(res.ok) {
                    // ì„±ê³µ ì‹œ ë³„ë„ ì•Œë¦¼ ì—†ì´ ì¡°ìš©íˆ ë°˜ì˜ (UX)
                    console.log("ìƒíƒœ ë³€ê²½ ì™„ë£Œ");
                    loadLiveStat(); // ì‹¤ì‹œê°„ ìˆ«ì ê°±ì‹ 
                } else {
                    alert("ë³€ê²½ ì‹¤íŒ¨");
                }
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>