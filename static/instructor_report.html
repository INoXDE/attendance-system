<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì˜ ì¢…í•© ë³´ê³ ì„œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .risk-card { border-left: 5px solid #dc3545; }
        .safe-card { border-left: 5px solid #198754; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold">ğŸ“Š ëˆ„ì  ìŠ¤íƒ & ìœ„í—˜êµ° ë³´ê³ ì„œ</h3>
            <button onclick="history.back()" class="btn btn-outline-secondary">ëŒì•„ê°€ê¸°</button>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">ê³µê²° ìŠ¹ì¸ìœ¨</h6>
                        <h1 class="display-4 fw-bold text-primary" id="approvalRate">-%</h1>
                        <small>ì „ì²´ ì‹ ì²­ ëŒ€ë¹„ ìŠ¹ì¸ ê±´ìˆ˜</small>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <canvas id="weeklyChart" style="max-height: 200px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <h5 class="fw-bold mb-3">ğŸš¨ ìœ„í—˜êµ° ë° ìŠ¤íƒ í˜„í™© (ì§€ê° 3íšŒ = ê²°ì„ 1íšŒ)</h5>
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ì´ë¦„</th>
                            <th>ë‹¨ìˆœ ê²°ì„</th>
                            <th>ë‹¨ìˆœ ì§€ê°</th>
                            <th>í™˜ì‚° ê²°ì„(ìŠ¤íƒ)</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="riskTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const COURSE_ID = urlParams.get('id');

        document.addEventListener('DOMContentLoaded', async () => {
            if(!COURSE_ID) return alert("ê°•ì˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            const res = await fetch(`/instructor/courses/${COURSE_ID}/stack_report`);
            const data = await res.json();

            // 1. ê³µê²° ìŠ¹ì¸ìœ¨
            document.getElementById('approvalRate').textContent = data.official_approval_rate + "%";

            // 2. ì£¼ì°¨ë³„ ì°¨íŠ¸
            new Chart(document.getElementById('weeklyChart'), {
                type: 'line',
                data: {
                    labels: data.weekly_attendance.map((_, i) => `${i+1}ì£¼ì°¨`),
                    datasets: [{
                        label: 'ì£¼ì°¨ë³„ ì¶œì„ë¥ (%)',
                        data: data.weekly_attendance,
                        borderColor: '#4a90e2',
                        tension: 0.3
                    }]
                }
            });

            // 3. ìœ„í—˜êµ° ë¦¬ìŠ¤íŠ¸
            const tbody = document.getElementById('riskTable');
            data.risk_group.forEach(s => {
                const badge = s.is_risk ? 
                    '<span class="badge bg-danger">ìœ„í—˜êµ°</span>' : 
                    '<span class="badge bg-success">ì •ìƒ</span>';
                
                const rowClass = s.is_risk ? 'table-danger' : '';

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="fw-bold">${s.student_name}</td>
                        <td>${s.total_absent}íšŒ</td>
                        <td>${s.total_late}íšŒ</td>
                        <td class="fw-bold text-danger">${s.converted_absent.toFixed(1)}</td>
                        <td>${badge}</td>
                    </tr>
                `;
            });
        });
    </script>
</body>
</html>