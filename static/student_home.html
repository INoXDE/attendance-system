<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inoxde - í•™ìƒ ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .course-card { 
            border: none; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            margin-bottom: 15px; cursor: pointer; transition: transform 0.2s;
        }
        .course-card:active { transform: scale(0.98); }
        .progress { height: 8px; border-radius: 4px; background-color: #e9ecef; }
        .header-area { background-color: white; padding: 20px 20px 10px 20px; border-bottom: 1px solid #eee; margin-bottom: 20px;}
    </style>
</head>
<body>
    <div class="header-area sticky-top">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="fw-bold m-0">ì•ˆë…•í•˜ì„¸ìš”, <span id="userName" class="text-primary">í•™ìƒ</span>ë‹˜</h5>
                <small class="text-muted">ì˜¤ëŠ˜ë„ í˜ì°¬ í•˜ë£¨ ë˜ì„¸ìš”!</small>
            </div>
            <button onclick="logout()" class="btn btn-sm btn-light border">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="container pb-5">
        <h6 class="text-muted fw-bold mb-3 px-1">ìˆ˜ê°• ì¤‘ì¸ ê°•ì˜</h6>
        <div id="courseList">
            <div class="text-center py-5 text-muted">ë¡œë”© ì¤‘...</div>
        </div>
    </div>
    <div id="globalNoticeArea" class="container mb-3" style="display:none;">
        <div class="alert alert-info d-flex align-items-center shadow-sm">
            <span class="me-2">ğŸ“¢</span> <strong id="noticeText"></strong>
        </div>
    </div>

    <div class="modal fade" id="liveAlertModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <h3 id="alertTitle">ğŸ“¢ ì•Œë¦¼</h3>
                <p id="alertMsg" class="mb-4"></p>
                <div id="voteButtons" style="display:none;">
                    <button class="btn btn-lg btn-primary me-2" onclick="castVote('Y')">ì°¬ì„± (Yes)</button>
                    <button class="btn btn-lg btn-secondary" onclick="castVote('N')">ë°˜ëŒ€ (No)</button>
                </div>
                <button id="alertClose" class="btn btn-success w-100 mt-3" data-bs-dismiss="modal" style="display:none;">í™•ì¸</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadDashboard();
        });

        async function loadUserInfo() {
            try {
                const res = await fetch('/users/me');
                if(res.ok) {
                    const user = await res.json();
                    document.getElementById('userName').textContent = user.name;
                } else { window.location.href = '/'; }
            } catch(e) { console.error(e); }
        }

        async function loadDashboard() {
            try {
                const res = await fetch('/student/dashboard');
                if (res.ok) {
                    const data = await res.json();
                    const listDiv = document.getElementById('courseList');
                    listDiv.innerHTML = ''; // ì´ˆê¸°í™”

                    data.forEach((course, index) => {
                        const myStat = course.reports[0]; // ë‚´ í†µê³„
                        // ê°•ì˜ IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ë²•ì´ í˜„ì¬ API êµ¬ì¡°ìƒ ì¡°ê¸ˆ ë³µì¡í•˜ë¯€ë¡œ 
                        // ì‹¤ì œë¡œëŠ” Course IDë„ responseì— í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. 
                        // ì—¬ê¸°ì„œëŠ” í¸ì˜ìƒ ìˆœì„œëŒ€ë¡œ 1, 2... ë¼ê³  ê°€ì •í•˜ê±°ë‚˜ API ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
                        // *ì„ì‹œì¡°ì¹˜: í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ 1ë²ˆ ê³ ì •í•˜ê³ , ì‹¤ì œë¡  ë°±ì—”ë“œì—ì„œ idë¥¼ ì¤˜ì•¼ í•¨*
                        const courseId = index + 1; 

                        listDiv.innerHTML += `
                            <div class="card course-card" onclick="location.href='/static/student_detail.html?id=${courseId}'">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <h6 class="fw-bold mb-0">${course.course_title}</h6>
                                        <span class="badge bg-light text-dark border">2025-2</span>
                                    </div>
                                    <div class="d-flex justify-content-between small text-muted mb-1">
                                        <span>ë‚˜ì˜ ì¶œì„ë¥ </span>
                                        <span class="fw-bold text-primary">${myStat.attendance_rate}%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-primary" style="width: ${myStat.attendance_rate}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/';
        }
        async function loadDashboard() {
            const res = await fetch('/student/dashboard');
            const data = await res.json();
            const listDiv = document.getElementById('courseList');
            listDiv.innerHTML = ''; 

            data.forEach(c => {
                // [NEW] ê²½ê³  ë° ê³µì§€ í‘œì‹œ
                let warningIcon = c.is_warning ? '<span class="text-danger fs-5 ms-2" title="ê²°ì„ ê²½ê³ !">âš ï¸</span>' : '';
                let noticeBadge = c.notice ? '<span class="badge bg-warning text-dark ms-2">ê³µì§€</span>' : '';
                
                // ê³µì§€ì‚¬í•­ ìˆìœ¼ë©´ ìƒë‹¨ì— ë„ìš°ê¸° (ë§ˆì§€ë§‰ ê°•ì˜ ê¸°ì¤€ ì˜ˆì‹œ)
                if(c.notice) {
                    document.getElementById('globalNoticeArea').style.display = 'block';
                    document.getElementById('noticeText').textContent = `[${c.course_title}] ${c.notice}`;
                }

                listDiv.innerHTML += `
                    <div class="card course-card" onclick="location.href='/static/student_detail.html?id=${c.course_id}'">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <h6 class="fw-bold mb-0">${c.course_title} ${warningIcon} ${noticeBadge}</h6>
                                <span class="badge bg-light text-dark border">${c.semester}</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-primary" style="width: ${c.attendance_rate}%"></div>
                            </div>
                            <small class="text-muted">${c.attendance_rate}% ì¶œì„</small>
                        </div>
                    </div>
                `;
            });
            
            // ì‹¤ì‹œê°„ í´ë§ ì‹œì‘ (5ì´ˆë§ˆë‹¤ ì²´í¬)
            setInterval(checkLiveStatus, 5000);
        }

        // [NEW] ì‹¤ì‹œê°„ ìƒíƒœ ì²´í¬ (ì¶œì„ ì˜¤í”ˆ / íˆ¬í‘œ)
        async function checkLiveStatus() {
            // í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ëª¨ë“  ê°•ì˜ì˜ ì„¸ì…˜ì„ ì²´í¬í•´ì•¼ í•¨.
            // API íš¨ìœ¨ì„ ìœ„í•´ ì—¬ê¸°ì„œëŠ” 1ë²ˆ ê°•ì˜(Demo)ë§Œ ì²´í¬í•œë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, 
            // /student/dashboard APIì— í˜„ì¬ í™œì„± ì„¸ì…˜ ì •ë³´ë¥¼ í¬í•¨ì‹œì¼œì•¼ í•¨.
            // ë°ëª¨ìš©ìœ¼ë¡œ 1ë²ˆ ê°•ì˜ì˜ ìµœì‹  ì„¸ì…˜ë§Œ ì²´í¬í•©ë‹ˆë‹¤.
            
            try {
                const res = await fetch('/student/courses/1/sessions'); 
                const sessions = await res.json();
                
                // í˜„ì¬ ì§„í–‰ì¤‘ì¸ íˆ¬í‘œë‚˜ ì¶œì„ ì°¾ê¸°
                const liveSession = sessions.find(s => s.is_open || s.is_voting);
                if(liveSession) {
                    showLivePopup(liveSession);
                }
            } catch(e) {}
        }

        let lastAlertId = null;
        function showLivePopup(session) {
            // ì´ë¯¸ ë„ìš´ ì•Œë¦¼ì´ë©´ ë¬´ì‹œ
            const alertId = `${session.id}-${session.is_open}-${session.is_voting}`;
            if(lastAlertId === alertId) return;
            lastAlertId = alertId;

            const modal = new bootstrap.Modal(document.getElementById('liveAlertModal'));
            const title = document.getElementById('alertTitle');
            const msg = document.getElementById('alertMsg');
            const voteBtns = document.getElementById('voteButtons');
            const closeBtn = document.getElementById('alertClose');

            if(session.is_voting) {
                title.textContent = "ğŸ—³ï¸ íœ´ê°• íˆ¬í‘œ ì§„í–‰ ì¤‘";
                msg.textContent = "êµìˆ˜ë‹˜ì´ íœ´ê°• ì—¬ë¶€ë¥¼ íˆ¬í‘œ ì¤‘ì…ë‹ˆë‹¤.";
                voteBtns.style.display = 'block';
                closeBtn.style.display = 'none';
                // ì„¸ì…˜ ID ì €ì¥
                voteBtns.dataset.sid = session.id;
            } else if(session.is_open) {
                title.textContent = "ğŸ“¢ ì¶œì„ ì²´í¬ ì‹œì‘!";
                msg.textContent = "ì§€ê¸ˆ ë°”ë¡œ ì¶œì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                voteBtns.style.display = 'none';
                closeBtn.style.display = 'block';
                closeBtn.onclick = () => location.href=`/static/student_detail.html?id=1`; // ì´ë™
            }
            modal.show();
        }

        async function castVote(val) {
            const sid = document.getElementById('voteButtons').dataset.sid;
            await fetch(`/student/sessions/${sid}/vote?vote=${val}`, { method: 'POST' });
            alert("íˆ¬í‘œ ì™„ë£Œ");
            bootstrap.Modal.getInstance(document.getElementById('liveAlertModal')).hide();
        }
    </script>
</body>
</html>