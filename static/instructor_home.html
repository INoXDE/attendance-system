<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>êµìˆ˜ìš© ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary px-3 mb-4">
        <span class="navbar-brand">ğŸ‘¨â€ğŸ« Professor Dashboard</span>
        <button onclick="logout()" class="btn btn-sm btn-light text-primary fw-bold">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>

    <div class="container">
        <h4 class="fw-bold mb-3">ë‚´ ê°•ì˜ ëª©ë¡</h4>
        <div id="courseList" class="row g-3"></div>

        <div id="sessionArea" class="mt-5" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold" id="selectedCourseTitle">ì£¼ì°¨ë³„ ê´€ë¦¬</h5>
                <button class="btn btn-secondary btn-sm" onclick="closeSessionArea()">ë‹«ê¸°</button>
            </div>
            <table class="table table-bordered bg-white shadow-sm">
                <thead class="table-light text-center">
                    <tr>
                        <th>ì£¼ì°¨</th>
                        <th>ë‚ ì§œ / ìƒíƒœ</th>
                        <th>ì¶œì„ ë°©ì‹</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="sessionListBody" class="text-center"></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="rescheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“… ë³´ê°•ì¼ ì„¤ì • (ë‚ ì§œ ë³€ê²½)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="rescheduleSessionId">
                    <p class="text-muted mb-2">ê¸°ì¡´ ë‚ ì§œ: <span id="oldDateDisplay" class="fw-bold"></span></p>
                    <label class="form-label">ë³€ê²½í•  ë‚ ì§œ ì„ íƒ</label>
                    <input type="datetime-local" id="newSessionDate" class="form-control">
                    <small class="text-danger">* ë‚ ì§œ ë³€ê²½ ì‹œ 'ê³µê²°(ê³µíœ´ì¼)' ìƒíƒœê°€ í•´ì œë˜ê³  ì •ìƒ ìˆ˜ì—…ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</small>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="submitReschedule()">ë³€ê²½ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', loadCourses);

        async function loadCourses() {
            const res = await fetch('/instructor/dashboard');
            if(!res.ok) return alert("ë¡œê·¸ì¸ í•„ìš”");
            const courses = await res.json();
            const div = document.getElementById('courseList');
            div.innerHTML = '';
            courses.forEach(c => {
                div.innerHTML += `
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm" style="cursor:pointer;" onclick="loadSessions(${c.id}, '${c.title}')">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">${c.title}</h5>
                                <p class="card-text text-muted">${c.semester} | ${c.day_of_week}</p>
                                <button class="btn btn-outline-primary w-100">ê°•ì˜ ê´€ë¦¬</button>
                            </div>
                        </div>
                    </div>`;
            });
        }

        async function loadSessions(cid, title) {
            document.getElementById('selectedCourseTitle').textContent = `[${title}] ì£¼ì°¨ë³„ ê´€ë¦¬`;
            document.getElementById('sessionArea').style.display = 'block';
            
            const res = await fetch(`/instructor/courses/${cid}/sessions`);
            const sessions = await res.json();
            const tbody = document.getElementById('sessionListBody');
            tbody.innerHTML = '';

            sessions.forEach(s => {
                const dateStr = new Date(s.session_date).toLocaleString('ko-KR', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
                
                // [í•µì‹¬] ê³µíœ´ì¼ ì²˜ë¦¬ UI
                let statusBadge = '';
                let actionBtn = '';

                if (s.is_holiday) {
                    statusBadge = `<span class="badge bg-danger">â›” ê³µíœ´ì¼ (ê³µê²°)</span>`;
                    actionBtn = `<button class="btn btn-sm btn-warning" onclick="openReschedule(${s.id}, '${s.session_date}')">ğŸ”„ ë³´ê°•ì¼ ì¡ê¸°</button>`;
                } else {
                    statusBadge = `<span class="badge bg-success">${dateStr}</span>`;
                    // ì¼ë°˜ ìˆ˜ì—…ë„ ë‚ ì§œ ë³€ê²½ ê°€ëŠ¥í•˜ê²Œ í• ì§€? -> ì‚¬ìš©ì ìš”êµ¬ëŠ” 'ê³µíœ´ì¼ì— ëŒ€ì¹˜ë˜ëŠ” ê°•ì˜ ë³´ê°•ì¼'ì´ë¯€ë¡œ ì—¬ê¸°ì„  ìƒëµ ê°€ëŠ¥í•˜ë‚˜ ìœ ì—°ì„±ì„ ìœ„í•´ ì—´ì–´ë‘ 
                    actionBtn = `<button class="btn btn-sm btn-outline-secondary" onclick="openReschedule(${s.id}, '${s.session_date}')">ë‚ ì§œ ë³€ê²½</button>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${s.week_number}ì£¼ì°¨</td>
                        <td>
                            ${statusBadge}<br>
                            <small class="text-muted">${dateStr}</small>
                        </td>
                        <td>${s.attendance_method}</td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            });
        }

        function openReschedule(sid, oldDate) {
            document.getElementById('rescheduleSessionId').value = sid;
            document.getElementById('oldDateDisplay').textContent = new Date(oldDate).toLocaleString();
            new bootstrap.Modal(document.getElementById('rescheduleModal')).show();
        }

        async function submitReschedule() {
            const sid = document.getElementById('rescheduleSessionId').value;
            const newDate = document.getElementById('newSessionDate').value;
            if(!newDate) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");

            const res = await fetch(`/instructor/sessions/${sid}/date`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ session_date: newDate })
            });

            if(res.ok) {
                alert("ë³´ê°•ì¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload(); // ê°„ë‹¨íˆ ìƒˆë¡œê³ ì¹¨
            } else {
                alert("ì˜¤ë¥˜ ë°œìƒ");
            }
        }

        function closeSessionArea() { document.getElementById('sessionArea').style.display = 'none'; }
        async function logout() { await fetch('/auth/logout', { method:'POST' }); window.location.href='/'; }
    </script>
</body>
</html>