<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì˜ ìƒì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .session-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;}
        .status-badge { width: 60px; text-align: center; }
    </style>
</head>
<body>
    <div class="bg-white sticky-top border-bottom p-3 mb-3 d-flex align-items-center">
        <a href="/static/student_home.html" class="btn btn-sm btn-light me-2">â†</a>
        <h5 class="m-0 fw-bold">ì¶œê²° ìƒì„¸ ì¡°íšŒ</h5>
    </div>

    <div class="container">
        <div id="sessionList">
            <div class="text-center mt-5 text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>
    <div class="modal fade" id="excuseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ğŸ“„ ê³µê²° ì‹ ì²­ì„œ ì œì¶œ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="excuseSessionId">
                    <div class="mb-3">
                        <label class="form-label">ì¦ë¹™ ì„œë¥˜ (ì§„ë‹¨ì„œ ë“±)</label>
                        <input type="file" id="excuseFile" class="form-control">
                    </div>
                    <ul class="text-muted small">
                        <li>íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ êµìˆ˜ë‹˜ê»˜ 'ê³µê²° ì‹ ì²­' ìƒíƒœë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
                        <li>êµìˆ˜ë‹˜ ìŠ¹ì¸ ì „ê¹Œì§€ëŠ” 'ì‹ ì²­ì¤‘' ìƒíƒœê°€ ë©ë‹ˆë‹¤.</li>
                    </ul>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="submitExcuse()">ì œì¶œí•˜ê¸°</button></div>
            </div>
        </div>
    </div>
<script>
        const urlParams = new URLSearchParams(window.location.search);
        const COURSE_ID = urlParams.get('id') || 1;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadSessions();
        });

        async function loadSessions() {
            try {
                const res = await fetch(`/student/courses/${COURSE_ID}/sessions`);
                const sessions = await res.json();
                const listDiv = document.getElementById('sessionList');
                listDiv.innerHTML = '';

                if (sessions.length === 0) {
                    listDiv.innerHTML = '<div class="text-center mt-5 text-muted">ë“±ë¡ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                sessions.forEach(s => {
                    const dateObj = new Date(s.session_date);
                    const weekDays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                    const dateStr = `${dateObj.getMonth()+1}.${dateObj.getDate()} (${weekDays[dateObj.getDay()]}) ${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2,'0')}`;

                    let statusHtml = '', actionHtml = '';

                    // ìƒíƒœ ë°°ì§€
                    if (s.my_status === 1) statusHtml = '<span class="badge bg-success status-badge">ì¶œì„</span>';
                    else if (s.my_status === 2) statusHtml = '<span class="badge bg-warning text-dark status-badge">ì§€ê°</span>';
                    else if (s.my_status === 3) statusHtml = '<span class="badge bg-danger status-badge">ê²°ì„</span>';
                    else if (s.my_status === 4) statusHtml = '<span class="badge bg-primary status-badge">ê³µê²°</span>';
                    else if (s.my_status === 5) statusHtml = '<span class="badge bg-info text-dark status-badge">ì‹ ì²­ì¤‘</span>'; // [NEW] ì‹ ì²­ì¤‘ ìƒíƒœ ì¶”ê°€
                    else statusHtml = '<span class="badge bg-secondary status-badge">ë¯¸ì •</span>';

                    // ë²„íŠ¼ ë¡œì§
                    if (s.is_open && s.my_status === 0) {
                        actionHtml = `<button class="btn btn-primary btn-sm" onclick="doAttend(${s.id}, '${s.attendance_method}')">ì¶œì„í•˜ê¸°</button>`;
                        statusHtml = '<span class="badge bg-info text-dark status-badge">ì§„í–‰ì¤‘</span>';
                    } else if (s.my_status === 1) {
                        actionHtml = '<small class="text-success fw-bold">ì¶œì„ì™„ë£Œ</small>';
                    } else if (s.my_status === 3) {
                         // ê²°ì„ ìƒíƒœì¼ ë•Œë§Œ ê³µê²° ì‹ ì²­ ë²„íŠ¼ í‘œì‹œ
                         actionHtml = `<button class="btn btn-outline-secondary btn-sm" onclick="applyExcuse(${s.id})">ê³µê²°ì‹ ì²­</button>`;
                    } else if (s.my_status === 5) {
                        actionHtml = '<small class="text-muted">ìŠ¹ì¸ ëŒ€ê¸°ì¤‘</small>';
                    }

                    listDiv.innerHTML += `
                        <div class="session-item">
                            <div>
                                <h6 class="m-0 fw-bold">${s.week_number}ì£¼ì°¨ ìˆ˜ì—…</h6>
                                <small class="text-muted">${dateStr}</small>
                                <div class="mt-1">${statusHtml}</div>
                            </div>
                            <div>${actionHtml}</div>
                        </div>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        async function doAttend(sessionId, method) {
            let code = "";
            if (method === 'AUTH_CODE') {
                code = prompt("êµìˆ˜ë‹˜ì´ ì•Œë ¤ì£¼ì‹  ì¸ì¦ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (code === null) return;
                if (code.trim() === "") { alert("ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            } else {
                if(!confirm("ì¶œì„ì²´í¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            }

            try {
                const url = `/student/sessions/${sessionId}/attend` + (code ? `?code=${code}` : "");
                const res = await fetch(url, { method: 'POST' });
                if (res.ok) {
                    alert("âœ… ì¶œì„ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    loadSessions();
                } else {
                    const err = await res.json();
                    alert("ì‹¤íŒ¨: " + err.detail);
                }
            } catch (e) { alert("í†µì‹  ì˜¤ë¥˜"); }
        }

        // [ì¤‘ë³µ ì œê±°ë¨] ê³µê²° ì‹ ì²­ ëª¨ë‹¬ ì—´ê¸°
        function applyExcuse(sessionId) {
            document.getElementById('excuseSessionId').value = sessionId;
            new bootstrap.Modal(document.getElementById('excuseModal')).show();
        }

        async function submitExcuse() {
            const sid = document.getElementById('excuseSessionId').value;
            const fileInput = document.getElementById('excuseFile');
            if(fileInput.files.length === 0) return alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            try {
                const res = await fetch(`/student/sessions/${sid}/excuse`, {
                    method: 'POST',
                    body: formData
                });
                if(res.ok) {
                    alert("ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
                    location.reload();
                } else { alert("ì—…ë¡œë“œ ì‹¤íŒ¨"); }
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>