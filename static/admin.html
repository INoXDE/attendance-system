<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹œìŠ¤í…œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav-link.active { font-weight: bold; background-color: #f8f9fa !important; border-bottom: 2px solid #0d6efd !important; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark px-3">
        <a class="navbar-brand" href="#">âš™ï¸ Admin Dashboard</a>
        <button onclick="logout()" class="btn btn-sm btn-outline-light">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>

    <div class="container py-4">
        <div class="alert alert-info d-flex justify-content-between align-items-center" id="systemStatus">
            <span>ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘...</span>
            <span class="badge bg-light text-dark" id="serverTime"></span>
        </div>

        <ul class="nav nav-tabs bg-white rounded-top shadow-sm px-2 pt-2">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-dept">ğŸ¢ í•™ê³¼ ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-user">ğŸ‘¥ ì‚¬ìš©ì ë“±ë¡</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-course">ğŸ“š ê°•ì¢Œ ê°œì„¤</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-log">ğŸ“œ ê°ì‚¬ ë¡œê·¸</a></li>
        </ul>

        <div class="tab-content bg-white shadow-sm p-4 rounded-bottom">
            
            <div class="tab-pane fade show active" id="tab-dept">
                <div class="input-group mb-3">
                    <input type="text" id="newDeptName" class="form-control" placeholder="ìƒˆ í•™ê³¼ ì´ë¦„ (ì˜ˆ: ì»´í“¨í„°ê³µí•™ê³¼)">
                    <button class="btn btn-primary" onclick="createDept()">ì¶”ê°€í•˜ê¸°</button>
                </div>
                <h6 class="text-muted">ë“±ë¡ëœ í•™ê³¼ ëª©ë¡</h6>
                <ul class="list-group" id="deptList"></ul>
            </div>

            <div class="tab-pane fade" id="tab-user">
                <form onsubmit="createUser(); return false;">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" id="uEmail" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label>ì´ë¦„</label>
                            <input type="text" id="uName" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="text" id="uPw" class="form-control" value="1234">
                        </div>
                        <div class="col-md-6">
                            <label>ê¶Œí•œ</label>
                            <select id="uRole" class="form-select">
                                <option value="STUDENT">í•™ìƒ</option>
                                <option value="INSTRUCTOR">êµìˆ˜</option>
                                <option value="ADMIN">ê´€ë¦¬ì</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>ì†Œì† í•™ê³¼</label>
                            <select id="uDept" class="form-select"><option value="">ì„ íƒí•˜ì„¸ìš”</option></select>
                        </div>
                        <div class="col-md-6">
                            <label>í•™ë²ˆ (í•™ìƒì¸ ê²½ìš°)</label>
                            <input type="text" id="uNum" class="form-control">
                        </div>
                        <div class="col-12 mt-3">
                            <button type="submit" class="btn btn-success w-100">ì‚¬ìš©ì ìƒì„±</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade" id="tab-course">
                <form onsubmit="createCourse(); return false;">
                    <div class="mb-3">
                        <label>ê°•ì˜ëª…</label>
                        <input type="text" id="cTitle" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>í•™ê¸°</label>
                        <input type="text" id="cSem" class="form-control" value="2025-2">
                    </div>
                    <div class="mb-3">
                        <label>ê°œì„¤ í•™ê³¼</label>
                        <select id="cDept" class="form-select"><option value="">ì„ íƒí•˜ì„¸ìš”</option></select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">ê°•ì˜ ìƒì„± (17ì£¼ì°¨ ìë™)</button>
                </form>
            </div>

            <div class="tab-pane fade" id="tab-log">
                <button class="btn btn-sm btn-secondary mb-2" onclick="loadLogs()">ìƒˆë¡œê³ ì¹¨</button>
                <div style="height:400px; overflow-y:auto; font-family:monospace; background:#f8f9fa; padding:10px;">
                    <table class="table table-sm table-striped">
                        <thead><tr><th>ì‹œê°„</th><th>í–‰ìœ„ì</th><th>ëŒ€ìƒ</th><th>ì•¡ì…˜</th><th>ìƒì„¸</th></tr></thead>
                        <tbody id="logList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadSystemStatus();
            loadDepts();
            loadLogs();
        });

        // ì‹œìŠ¤í…œ ìƒíƒœ
        async function loadSystemStatus() {
            try {
                const res = await fetch('/admin/system-status');
                if(!res.ok) return;
                const data = await res.json();
                document.getElementById('systemStatus').innerHTML = `
                    <strong>ğŸŸ¢ ì‹œìŠ¤í…œ ì •ìƒ ê°€ë™ ì¤‘</strong> 
                    (DB: ${data.database}, ìœ ì €: ${data.users}ëª…, ê°•ì˜: ${data.courses}ê°œ)
                `;
                document.getElementById('serverTime').textContent = new Date(data.server_time).toLocaleString();
            } catch(e) {
                document.getElementById('systemStatus').className = "alert alert-danger";
                document.getElementById('systemStatus').textContent = "ğŸ”´ ì‹œìŠ¤í…œ ì—°ê²° ì˜¤ë¥˜";
            }
        }

        // í•™ê³¼ ê´€ë¦¬
        async function loadDepts() {
            const res = await fetch('/admin/departments');
            const depts = await res.json();
            const list = document.getElementById('deptList');
            const selects = [document.getElementById('uDept'), document.getElementById('cDept')];
            
            list.innerHTML = '';
            selects.forEach(s => s.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>');

            depts.forEach(d => {
                list.innerHTML += `<li class="list-group-item">${d.name} <span class="badge bg-secondary float-end">ID: ${d.id}</span></li>`;
                selects.forEach(s => s.innerHTML += `<option value="${d.id}">${d.name}</option>`);
            });
        }

        async function createDept() {
            const name = document.getElementById('newDeptName').value;
            if(!name) return alert("í•™ê³¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”");
            
            const res = await fetch('/admin/departments', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name})
            });
            if(res.ok) { alert("ë“±ë¡ ì™„ë£Œ"); loadDepts(); document.getElementById('newDeptName').value=''; }
        }

        // ì‚¬ìš©ì ìƒì„±
        async function createUser() {
            const data = {
                email: document.getElementById('uEmail').value,
                password: document.getElementById('uPw').value,
                name: document.getElementById('uName').value,
                role: document.getElementById('uRole').value,
                department_id: document.getElementById('uDept').value || null,
                student_number: document.getElementById('uNum').value || null
            };
            const res = await fetch('/admin/users', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("ì‚¬ìš©ì ìƒì„± ì™„ë£Œ!"); }
            else { alert("ìƒì„± ì‹¤íŒ¨ (ì´ë©”ì¼ ì¤‘ë³µ ë“± í™•ì¸)"); }
        }

        // ê°•ì˜ ìƒì„±
        async function createCourse() {
            const data = {
                title: document.getElementById('cTitle').value,
                semester: document.getElementById('cSem').value,
                department_id: document.getElementById('cDept').value || null
            };
            const res = await fetch('/admin/courses', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("ê°•ì˜ ê°œì„¤ ë° 17ì£¼ì°¨ ìƒì„± ì™„ë£Œ!"); }
            else { alert("ê°œì„¤ ì‹¤íŒ¨"); }
        }

        // ê°ì‚¬ ë¡œê·¸
        async function loadLogs() {
            const res = await fetch('/admin/audit-logs');
            const logs = await res.json();
            const tbody = document.getElementById('logList');
            tbody.innerHTML = '';
            logs.forEach(l => {
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(l.created_at).toLocaleString()}</td>
                        <td>User ${l.actor_id}</td>
                        <td>${l.target_type} ${l.target_id}</td>
                        <td>${l.action}</td>
                        <td>${l.details || '-'}</td>
                    </tr>
                `;
            });
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/';
        }
    </script>
</body>
</html>