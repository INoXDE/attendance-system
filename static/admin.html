<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹œìŠ¤í…œ ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .nav-link.active { font-weight: bold; border-bottom: 2px solid #0d6efd !important; }
        .table-hover tbody tr:hover { background-color: #f1f3f5; cursor: pointer; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark px-3 mb-4">
        <a class="navbar-brand" href="#">âš™ï¸ Admin Control Center</a>
        <button onclick="logout()" class="btn btn-sm btn-outline-light">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>

    <div class="container">
        <div class="alert alert-success d-flex justify-content-between align-items-center mb-4" id="systemStatus">
            <span>Checking System...</span>
        </div>

        <ul class="nav nav-tabs bg-white rounded-top shadow-sm px-2 pt-2">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-dept">ğŸ¢ í•™ê³¼ ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-user">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-course">ğŸ“š ê°•ì¢Œ ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-log">ğŸ“œ ê°ì‚¬ ë¡œê·¸</a></li>
        </ul>

        <div class="tab-content bg-white shadow-sm p-4 rounded-bottom">
            
            <div class="tab-pane fade show active" id="tab-dept">
                <div class="input-group mb-3">
                    <input type="text" id="newDeptName" class="form-control" placeholder="ìƒˆ í•™ê³¼ ì´ë¦„">
                    <button class="btn btn-primary" onclick="createDept()">ì¶”ê°€</button>
                </div>
                <ul class="list-group" id="deptList"></ul>
            </div>

            <div class="tab-pane fade" id="tab-user">
                <div class="card mb-4 bg-light border-0">
                    <div class="card-body">
                        <h6 class="fw-bold">â• ìƒˆ ì‚¬ìš©ì ë“±ë¡</h6>
                        <div class="row g-2">
                            <div class="col-md-3"><input type="email" id="uEmail" class="form-control" placeholder="ì´ë©”ì¼"></div>
                            <div class="col-md-2"><input type="text" id="uName" class="form-control" placeholder="ì´ë¦„"></div>
                            <div class="col-md-2"><input type="text" id="uPw" class="form-control" placeholder="ë¹„ë²ˆ(1234)" value="1234"></div>
                            <div class="col-md-2">
                                <select id="uRole" class="form-select">
                                    <option value="STUDENT">í•™ìƒ</option>
                                    <option value="INSTRUCTOR">êµìˆ˜</option>
                                    <option value="ADMIN">ê´€ë¦¬ì</option>
                                </select>
                            </div>
                            <div class="col-md-2"><select id="uDept" class="form-select"></select></div>
                            <div class="col-md-1"><button class="btn btn-success w-100" onclick="createUser()">ë“±ë¡</button></div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold">ì‚¬ìš©ì ëª©ë¡</h6>
                    <input type="text" id="userSearch" class="form-control w-25 form-control-sm" placeholder="ê²€ìƒ‰..." onkeyup="filterUsers()">
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                        <thead class="table-light sticky-top">
                            <tr><th>ID</th><th>ì´ë¦„</th><th>í•™ë²ˆ/ID</th><th>ê¶Œí•œ</th><th>í•™ê³¼</th><th>ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody id="userListBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-course">
                <div class="card mb-4 bg-light border-0">
                    <div class="card-body">
                        <h6 class="fw-bold">â• ìƒˆ ê°•ì˜ ê°œì„¤</h6>
                        <div class="row g-2">
                            <div class="col-md-3"><input type="text" id="cTitle" class="form-control" placeholder="ê°•ì˜ëª…"></div>
                            <div class="col-md-2"><input type="text" id="cSem" class="form-control" value="2025-2" placeholder="í•™ê¸°"></div>
                            <div class="col-md-2">
                                <select id="cType" class="form-select"><option value="ì „ê³µ">ì „ê³µ</option><option value="êµì–‘">êµì–‘</option></select>
                            </div>
                            <div class="col-md-1">
                                <select id="cDay" class="form-select">
                                    <option value="Mon">ì›”</option><option value="Tue">í™”</option><option value="Wed">ìˆ˜</option><option value="Thu">ëª©</option><option value="Fri">ê¸ˆ</option>
                                </select>
                            </div>
                            <div class="col-md-2"><select id="cInst" class="form-select"><option value="">ë‹´ë‹¹ êµìˆ˜</option></select></div>
                            <div class="col-md-2"><select id="cDept" class="form-select"><option value="">ê°œì„¤ í•™ê³¼</option></select></div>
                            <div class="col-12 mt-2 text-end">
                                <button class="btn btn-primary" onclick="createCourse()">ê°•ì˜ ê°œì„¤</button>
                            </div>
                        </div>
                    </div>
                </div>

                <h6 class="fw-bold mb-2">ê°œì„¤ëœ ê°•ì˜ ëª©ë¡</h6>
                <table class="table table-hover">
                    <thead class="table-light"><tr><th>ID</th><th>ê°•ì˜ëª…</th><th>ì´ìˆ˜</th><th>ìš”ì¼</th><th>í•™ê¸°</th><th>êµìˆ˜</th><th>í•™ê³¼</th><th>ê´€ë¦¬</th></tr></thead>
                    <tbody id="courseListBody"></tbody>
                </table>
            </div>

            <div class="tab-pane fade" id="tab-log">
                <button class="btn btn-sm btn-secondary mb-2" onclick="loadLogs()">ìƒˆë¡œê³ ì¹¨</button>
                <div style="height:400px; overflow-y:auto; font-family:monospace; background:#f8f9fa; padding:10px;">
                    <table class="table table-sm table-striped">
                        <thead><tr><th>ì‹œê°„</th><th>í–‰ìœ„ì</th><th>ëŒ€ìƒ</th><th>ì•¡ì…˜</th><th>ìƒì„¸</th></tr></thead>
                        <tbody id="logList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="mb-2"><label>ì´ë¦„</label><input type="text" id="editUserName" class="form-control"></div>
                    <div class="mb-2"><label>ì´ë©”ì¼</label><input type="email" id="editUserEmail" class="form-control"></div>
                    <div class="mb-2"><label>í•™ë²ˆ</label><input type="text" id="editUserNum" class="form-control"></div>
                    <div class="mb-2"><label>ê¶Œí•œ</label>
                        <select id="editUserRole" class="form-select"><option value="STUDENT">í•™ìƒ</option><option value="INSTRUCTOR">êµìˆ˜</option><option value="ADMIN">ê´€ë¦¬ì</option></select>
                    </div>
                    <div class="mb-2"><label>í•™ê³¼</label><select id="editUserDept" class="form-select"></select></div>
                    <div class="mb-2"><label>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</label><input type="text" id="editUserPw" class="form-control" placeholder="ë³€ê²½ì‹œì—ë§Œ ì…ë ¥"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger me-auto" onclick="deleteUser()">ì‚­ì œ</button>
                    <button class="btn btn-primary" onclick="saveUserEdit()">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="courseManageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ê°•ì¢Œ ìƒì„¸ ê´€ë¦¬</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="manageCourseId">
                    <div class="row mb-4 border-bottom pb-3 g-2">
                        <div class="col-md-4">
                            <label class="fw-bold small">ê°•ì˜ëª…</label>
                            <input type="text" id="manageCTitle" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="fw-bold small">ì´ìˆ˜</label>
                            <select id="manageCType" class="form-select"><option value="ì „ê³µ">ì „ê³µ</option><option value="êµì–‘">êµì–‘</option></select>
                        </div>
                        <div class="col-md-2">
                            <label class="fw-bold small">ìš”ì¼</label>
                            <select id="manageCDay" class="form-select">
                                <option value="Mon">ì›”</option><option value="Tue">í™”</option><option value="Wed">ìˆ˜</option><option value="Thu">ëª©</option><option value="Fri">ê¸ˆ</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="fw-bold small">í•™ê³¼</label>
                            <select id="manageCDept" class="form-select"></select>
                        </div>
                        <div class="col-md-2">
                            <label class="fw-bold small">êµìˆ˜</label>
                            <select id="manageCInst" class="form-select"></select>
                        </div>
                        <div class="col-12 mt-2 text-end">
                            <button class="btn btn-danger btn-sm me-2" onclick="deleteCourse()">ì‚­ì œ</button>
                            <button class="btn btn-primary btn-sm" onclick="saveCourseEdit()">ì €ì¥</button>
                        </div>
                    </div>

                    <h6 class="fw-bold">ğŸ“ ìˆ˜ê°•ìƒ ê´€ë¦¬</h6>
                    <div class="input-group mb-2">
                        <input type="text" id="enrollNum" class="form-control" placeholder="í•™ë²ˆ ì…ë ¥ (ì˜ˆ: 2025001)">
                        <button class="btn btn-outline-success" onclick="enrollStudent()">ìˆ˜ê°•ìƒ ì¶”ê°€</button>
                    </div>
                    <ul class="list-group" id="enrolledList" style="max-height: 200px; overflow-y: auto;"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let allDepts = [];
        let allUsers = [];
        const DAY_DISPLAY = { "Mon": "ì›”", "Tue": "í™”", "Wed": "ìˆ˜", "Thu": "ëª©", "Fri": "ê¸ˆ" };

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("ğŸš€ ê´€ë¦¬ì í˜ì´ì§€ ë¡œë”© ì‹œì‘...");
            loadSystemStatus();
            await loadDepts();
            await loadUsers();
            loadCourses();
            loadLogs();
        });

        async function loadSystemStatus() {
            try {
                const res = await fetch('/admin/system-status');
                if(!res.ok) throw new Error();
                const data = await res.json();
                document.getElementById('systemStatus').innerHTML = `<span><strong>ğŸŸ¢ System Online</strong> (Users: ${data.users}, Courses: ${data.courses})</span>`;
            } catch(e) { document.getElementById('systemStatus').className="alert alert-danger"; document.getElementById('systemStatus').textContent="ğŸ”´ Offline (ì„œë²„ ì—°ê²° ì•ˆë¨)"; }
        }

        async function loadDepts() {
            const res = await fetch('/admin/departments');
            allDepts = await res.json();
            const list = document.getElementById('deptList');
            list.innerHTML = '';
            
            // [FIX] ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤. ì£¼ì„ì„ ì‹¤ì œ ì½”ë“œë¡œ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤.
            const selects = ['uDept', 'cDept', 'editUserDept', 'manageCDept'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = '<option value="">ì„ íƒ...</option>';
                    allDepts.forEach(d => el.innerHTML += `<option value="${d.id}">${d.name}</option>`);
                }
            });

            allDepts.forEach(d => {
                // ì‚­ì œ ë²„íŠ¼ í™œì„±í™” (ì•ˆì „ì¥ì¹˜ëŠ” ë°±ì—”ë“œì— ìœ„ì„)
                const isSafe = (d.user_count === 0 && d.course_count === 0);
                list.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between">
                        <span>${d.name} <small class="text-muted">(ğŸ‘¤${d.user_count}/ğŸ“š${d.course_count})</small></span> 
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="renameDept(${d.id},'${d.name}')">ì´ë¦„</button>
                            <button class="btn btn-outline-danger" onclick="deleteDept(${d.id})">ì‚­ì œ</button>
                        </div>
                    </li>`;
            });
        }
        
        async function loadUsers() {
            const res = await fetch('/admin/users');
            allUsers = await res.json();
            const selects = ['cInst', 'manageCInst'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = '<option value="">ë‹´ë‹¹ êµìˆ˜ ì„ íƒ</option>';
                    allUsers.filter(u => u.role === 'INSTRUCTOR').forEach(u => {
                        el.innerHTML += `<option value="${u.id}">${u.name} (${u.email})</option>`;
                    });
                }
            });
            renderUsers(allUsers);
        }

        function renderUsers(users) {
            const tbody = document.getElementById('userListBody');
            tbody.innerHTML = '';
            users.forEach(u => {
                const dName = allDepts.find(d => d.id === u.department_id)?.name || '-';
                tbody.innerHTML += `<tr><td>${u.id}</td><td>${u.name}</td><td>${u.student_number||u.email}</td><td><span class="badge bg-secondary">${u.role}</span></td><td>${dName}</td><td><button class="btn btn-sm btn-outline-dark" onclick="openUserModal(${u.id})">ìˆ˜ì •</button></td></tr>`;
            });
        }
        function filterUsers() {
            const q = document.getElementById('userSearch').value.toLowerCase();
            renderUsers(allUsers.filter(u => u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)));
        }

        // --- ê°•ì˜ ìƒì„± ---
        async function createCourse() {
            const title = document.getElementById('cTitle').value;
            const semester = document.getElementById('cSem').value;
            const type = document.getElementById('cType').value;
            const day = document.getElementById('cDay').value;
            const instId = document.getElementById('cInst').value;
            const deptId = document.getElementById('cDept').value;

            if(!title) return alert("ê°•ì˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(!semester) return alert("í•™ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(!instId) return alert("ë‹´ë‹¹ êµìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            if(!deptId) return alert("ê°œì„¤ í•™ê³¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            const payload = {
                title: title, semester: semester, course_type: type, day_of_week: day,
                instructor_id: parseInt(instId), department_id: parseInt(deptId)
            };

            try {
                const res = await fetch('/admin/courses', { 
                    method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) 
                });
                if(res.ok) { 
                    alert("âœ… ê°•ì˜ ê°œì„¤ ì™„ë£Œ!"); 
                    document.getElementById('cTitle').value = ''; 
                    loadCourses(); 
                } else { 
                    const err = await res.json(); 
                    alert("âŒ ê°œì„¤ ì‹¤íŒ¨: " + (err.detail || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")); 
                }
            } catch (e) { console.error(e); alert("âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜"); }
        }

        async function createDept() {
            const name = document.getElementById('newDeptName').value;
            if(!name) return;
            const res = await fetch('/admin/departments', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name}) });
            if(res.ok) { loadDepts(); document.getElementById('newDeptName').value=''; } else { alert((await res.json()).detail); }
        }
        async function renameDept(id, old) {
            const name = prompt("ìƒˆ ì´ë¦„:", old);
            if(!name || name===old) return;
            const res = await fetch(`/admin/departments/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name}) });
            if(res.ok) loadDepts(); else alert((await res.json()).detail);
        }
        async function deleteDept(id) {
            if(!confirm("ì‚­ì œ?")) return;
            const res = await fetch(`/admin/departments/${id}`, { method:'DELETE' });
            if(res.ok) loadDepts(); else alert((await res.json()).detail);
        }
        async function createUser() {
            const data = {
                email: document.getElementById('uEmail').value,
                password: document.getElementById('uPw').value,
                name: document.getElementById('uName').value,
                role: document.getElementById('uRole').value,
                department_id: document.getElementById('uDept').value || null
            };
            const res = await fetch('/admin/users', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            if(res.ok) { alert("ì™„ë£Œ"); loadUsers(); } else alert("ì‹¤íŒ¨: " + (await res.json()).detail);
        }

        function openUserModal(uid) {
            const u = allUsers.find(x => x.id === uid);
            document.getElementById('editUserId').value = u.id;
            document.getElementById('editUserName').value = u.name;
            document.getElementById('editUserEmail').value = u.email;
            document.getElementById('editUserNum').value = u.student_number || '';
            document.getElementById('editUserRole').value = u.role;
            document.getElementById('editUserDept').value = u.department_id || '';
            document.getElementById('editUserPw').value = '';
            new bootstrap.Modal(document.getElementById('userEditModal')).show();
        }
        async function saveUserEdit() {
            const uid = document.getElementById('editUserId').value;
            const data = {
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                student_number: document.getElementById('editUserNum').value,
                role: document.getElementById('editUserRole').value,
                department_id: document.getElementById('editUserDept').value || null,
                password: document.getElementById('editUserPw').value || null
            };
            await fetch(`/admin/users/${uid}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            location.reload();
        }
        async function deleteUser() {
            const uid = document.getElementById('editUserId').value;
            if(!confirm("ì‚­ì œ?")) return;
            const res = await fetch(`/admin/users/${uid}`, { method:'DELETE' });
            if(res.ok) location.reload(); else alert((await res.json()).detail);
        }

        async function loadCourses() {
            const res = await fetch('/admin/courses');
            const courses = await res.json();
            const tbody = document.getElementById('courseListBody');
            tbody.innerHTML = '';
            courses.forEach(c => {
                const instName = allUsers.find(u => u.id === c.instructor_id)?.name || 'ë¯¸ë°°ì •';
                const deptName = allDepts.find(d => d.id === c.department_id)?.name || '-';
                const dayStr = DAY_DISPLAY[c.day_of_week] || c.day_of_week;
                tbody.innerHTML += `<tr><td>${c.id}</td><td class="fw-bold">${c.title}</td><td>${c.course_type}</td><td>${dayStr}</td><td>${c.semester}</td><td>${instName}</td><td>${deptName}</td><td><button class="btn btn-sm btn-outline-dark" onclick="openCourseModal(${c.id})">ê´€ë¦¬</button></td></tr>`;
            });
        }
        
        async function openCourseModal(cid) {
            const res = await fetch('/admin/courses');
            const courses = await res.json();
            const c = courses.find(x => x.id === cid);
            
            document.getElementById('manageCourseId').value = c.id;
            document.getElementById('manageCTitle').value = c.title;
            document.getElementById('manageCType').value = c.course_type;
            document.getElementById('manageCDay').value = c.day_of_week;
            document.getElementById('manageCInst').value = c.instructor_id;
            document.getElementById('manageCDept').value = c.department_id || ""; 

            loadEnrolledStudents(cid);
            new bootstrap.Modal(document.getElementById('courseManageModal')).show();
        }

        async function saveCourseEdit() {
            const cid = document.getElementById('manageCourseId').value;
            const data = {
                title: document.getElementById('manageCTitle').value,
                course_type: document.getElementById('manageCType').value,
                day_of_week: document.getElementById('manageCDay').value,
                instructor_id: parseInt(document.getElementById('manageCInst').value),
                department_id: parseInt(document.getElementById('manageCDept').value)
            };
            await fetch(`/admin/courses/${cid}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            alert("ì €ì¥ë¨"); loadCourses();
        }
        async function deleteCourse() {
            const cid = document.getElementById('manageCourseId').value;
            if(!confirm("ì‚­ì œ?")) return;
            await fetch(`/admin/courses/${cid}`, { method:'DELETE' });
            location.reload();
        }
        async function loadEnrolledStudents(cid) {
            const res = await fetch(`/admin/courses/${cid}/students`);
            const students = await res.json();
            const list = document.getElementById('enrolledList');
            list.innerHTML = '';
            if(students.length === 0) list.innerHTML = '<li class="list-group-item text-muted">ìˆ˜ê°•ìƒ ì—†ìŒ</li>';
            students.forEach(s => {
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${s.name} (${s.student_number})</span><button class="btn btn-sm btn-danger py-0" onclick="removeStudent(${cid}, ${s.id})">ì‚­ì œ</button></li>`;
            });
        }
        async function enrollStudent() {
            const cid = document.getElementById('manageCourseId').value;
            const num = document.getElementById('enrollNum').value; 
            const res = await fetch(`/admin/courses/${cid}/students?student_number=${num}`, { method:'POST' });
            if(res.ok) { loadEnrolledStudents(cid); document.getElementById('enrollNum').value=''; }
            else alert("í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ ë“±ë¡ë¨");
        }
        async function removeStudent(cid, uid) {
            if(!confirm("ìˆ˜ê°• ì·¨ì†Œ?")) return;
            await fetch(`/admin/courses/${cid}/students/${uid}`, { method:'DELETE' });
            loadEnrolledStudents(cid);
        }
        async function loadLogs() {
            const res = await fetch('/admin/audit-logs');
            const logs = await res.json();
            const tbody = document.getElementById('logList');
            tbody.innerHTML = '';
            logs.forEach(l => tbody.innerHTML += `<tr><td>${new Date(l.created_at).toLocaleString()}</td><td>User ${l.actor_id}</td><td>${l.target_type} ${l.target_id}</td><td>${l.action}</td><td>${l.details||'-'}</td></tr>`);
        }
        async function logout() { await fetch('/auth/logout', { method:'POST' }); window.location.href='/'; }
    </script>
</body>
</html>